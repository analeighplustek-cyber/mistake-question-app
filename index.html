<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <title>eCoach - 智慧錯題管理系統</title>
    <style>
        :root {
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --success: #28a745;
            --error: #dc3545;
            --text-muted: #6c757d;
            --bg-light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            min-height: 100vh;
            padding: 20px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 15px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        h1 {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, var(--primary-start), var(--primary-end));
            color: white;
            font-size: 1.5em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--bg-light);
            border-bottom: 3px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-start);
            background: white;
            border-bottom: 3px solid var(--primary-start);
        }

        .tab-content {
            padding: 20px;
            min-height: 400px;
        }

        .hidden {
            display: none;
        }

        #camera {
            width: 100%;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 14px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin: 5px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--error), #c82333);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            font-family: inherit;
        }

        .question-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            padding: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .question-item:hover {
            transform: translateY(-5px);
        }

        .question-item img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .selection-overlay {
            position: absolute;
            border: 2px dashed var(--primary-start);
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
        }

        .selection-overlay.answer {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            padding: 20px;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 20px;
            border-radius: 20px;
            max-width: 500px;
            max-height: calc(100vh - 40px);
            overflow: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #photo-preview {
            max-width: 100%;
            border-radius: 15px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>

    <div class="container">
        <h1>eCoach - 智慧錯題管理</h1>
        
        <nav class="tabs">
            <button class="tab-btn active" data-tab="capture">📸 拍照/匯入</button>
            <button class="tab-btn" data-tab="collection">📚 錯題集</button>
        </nav>
        
        <main>
            <section class="tab-content" id="capture-tab">
                <div style="text-align: center;">
                    <video id="camera" autoplay playsinline muted></video>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                    
                    <div>
                        <button class="btn-primary" onclick="MistakeApp.capturePhoto()">📸 拍照</button>
                        <button class="btn-secondary" onclick="document.getElementById('file-input').click()">📁 匯入圖片</button>
                        <button class="btn-secondary" onclick="MistakeApp.switchCamera()">🔄 切換相機</button>
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                    </div>
                </div>
                
                <div id="edit-container" class="hidden" style="margin-top: 20px;">
                    <div style="position: relative; display: inline-block;">
                        <img id="photo-preview" alt="預覽圖片" style="display: none;">
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn-secondary" onclick="MistakeApp.startSelection('question')">📝 框選題目</button>
                        <button class="btn-success" onclick="MistakeApp.startSelection('answer')">✅ 框選答案</button>
                        <button class="btn-danger" onclick="MistakeApp.clearSelections()">🗑️ 清除框選</button>
                    </div>
                    
                    <div class="form-group">
                        <label>科目:</label>
                        <select id="subject" onchange="handleSubjectChange()">
                            <option value="">請選擇</option>
                            <option value="chinese">國文</option>
                            <option value="english">英文</option>
                            <option value="math">數學</option>
                            <option value="science">自然</option>
                            <option value="social">社會</option>
                            <option value="custom">自訂科目...</option>
                        </select>
                        <input type="text" id="custom-subject" placeholder="請輸入科目名稱" style="display: none; width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>題型:</label>
                        <select id="question-type">
                            <option value="">請選擇</option>
                            <option value="true-false">是非題</option>
                            <option value="multiple-choice">選擇題</option>
                            <option value="short-answer">簡答題</option>
                            <option value="essay">申論題</option>
                            <option value="calculation">計算題</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>錯誤原因:</label>
                        <select id="error-reason">
                            <option value="">請選擇</option>
                            <option value="dont-know">此題不會</option>
                            <option value="calculation-error">計算錯誤</option>
                            <option value="concept-error">觀念錯誤</option>
                            <option value="careless">粗心</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>筆記:</label>
                        <textarea id="notes" placeholder="添加筆記..."></textarea>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn-success" onclick="MistakeApp.saveQuestion()">💾 儲存</button>
                        <button class="btn-danger" onclick="MistakeApp.resetEdit()">❌ 取消</button>
                    </div>
                </div>
            </section>
            
            <section class="tab-content hidden" id="collection-tab">
                <h2 style="text-align: center;">📚 錯題集</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn-secondary" onclick="MistakeApp.exportData()">📤 匯出</button>
                    <button class="btn-secondary" onclick="document.getElementById('import-data-input').click()">📥 匯入</button>
                    <button class="btn-danger" onclick="MistakeApp.clearAllData()">🗑️ 清除</button>
                    <input type="file" id="import-data-input" accept=".json" class="hidden">
                </div>
                
                <p style="text-align: center; color: var(--text-muted);">
                    總計: <span id="total-questions">0</span> 題
                </p>
                
                <div class="form-group">
                    <label>篩選科目:</label>
                    <select id="filter-subject" onchange="MistakeApp.filterQuestions()">
                        <option value="all">全部</option>
                        <option value="chinese">國文</option>
                        <option value="english">英文</option>
                        <option value="math">數學</option>
                        <option value="science">自然</option>
                        <option value="social">社會</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                
                <div id="questions-list">
                    <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                        尚未添加任何錯題
                    </p>
                </div>
            </section>
        </main>
    </div>
    
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="MistakeApp.closeModal()">&times;</span>
            <h2>錯題詳情</h2>
            <img id="modal-image" style="width: 100%; border-radius: 10px;">
            <p><strong>科目:</strong> <span id="modal-subject"></span></p>
            <p><strong>題型:</strong> <span id="modal-type"></span></p>
            <p><strong>錯誤原因:</strong> <span id="modal-reason"></span></p>
            <p><strong>筆記:</strong></p>
            <p id="modal-notes" style="background: var(--bg-light); padding: 10px; border-radius: 10px;"></p>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-danger" onclick="MistakeApp.deleteQuestion()">🗑️ 刪除</button>
            </div>
        </div>
    </div>
    
    <script>
        const MistakeApp = (function() {
            let currentStream = null;
            let facingMode = 'environment';
            let questions = [];
            let currentQuestionId = null;
            let selectionMode = false;
            let selectionStart = null;
            let selections = [];
            let currentSelectionType = 'question';

            // 初始化
            document.addEventListener('DOMContentLoaded', function() {
                loadQuestions();
                initCamera();
                setupFileInput();
                setupImportData();
                setupSubjectHandler();
            });

            function setupSubjectHandler() {
                window.handleSubjectChange = function() {
                    const select = document.getElementById('subject');
                    const customInput = document.getElementById('custom-subject');
                    
                    if (select.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                        customInput.value = '';
                    }
                };
            }

            function setupFileInput() {
                document.getElementById('file-input').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            showPhotoPreview(event.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function setupImportData() {
                document.getElementById('import-data-input').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.questions && Array.isArray(data.questions)) {
                                if (confirm(`即將匯入 ${data.questions.length} 筆錯題，確定繼續？`)) {
                                    questions = [...questions, ...data.questions];
                                    saveQuestions();
                                    displayQuestions();
                                    showNotification('資料已匯入');
                                }
                            }
                        } catch (error) {
                            showNotification('匯入失敗', 'error');
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                });
            }

            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            function loadQuestions() {
                const saved = localStorage.getItem('questions');
                questions = saved ? JSON.parse(saved) : [];
                updateDisplay();
            }

            function saveQuestions() {
                localStorage.setItem('questions', JSON.stringify(questions));
                updateDisplay();
            }

            async function initCamera() {
                try {
                    // 檢查瀏覽器支援
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showNotification('此瀏覽器不支援相機功能，請使用匯入功能', 'error');
                        disableCameraButtons();
                        return;
                    }

                    // 檢查權限狀態（如果支援）
                    if (navigator.permissions && navigator.permissions.query) {
                        try {
                            const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                            
                            if (permissionStatus.state === 'denied') {
                                showNotification('相機權限已被拒絕，請在瀏覽器設定中開啟相機權限', 'error');
                                disableCameraButtons();
                                showCameraPermissionGuide();
                                return;
                            }
                        } catch (e) {
                            console.log('無法查詢權限狀態:', e);
                        }
                    }

                    // 請求相機權限
                    const constraints = { 
                        video: { 
                            facingMode: facingMode,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    };
                    
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    const video = document.getElementById('camera');
                    video.srcObject = currentStream;
                    
                    console.log('相機初始化成功');
                    showNotification('相機已開啟');
                } catch (error) {
                    console.error('相機錯誤:', error);
                    handleCameraError(error);
                }
            }

            function handleCameraError(error) {
                let errorMessage = '無法開啟相機';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = '請允許相機權限';
                    showCameraPermissionGuide();
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = '找不到相機裝置，請使用匯入功能';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = '相機正被其他應用程式使用';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = '相機不支援所需的設定';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '請使用 HTTPS 或 localhost 開啟此頁面';
                }
                
                showNotification(errorMessage, 'error');
                disableCameraButtons();
            }

            function disableCameraButtons() {
                const captureBtn = document.getElementById('capture-btn');
                const switchBtn = document.getElementById('switch-camera-btn');
                if (captureBtn) captureBtn.disabled = true;
                if (switchBtn) switchBtn.disabled = true;
            }

            function showCameraPermissionGuide() {
                const guide = document.createElement('div');
                guide.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fff;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    max-width: 90%;
                    z-index: 2000;
                `;
                
                guide.innerHTML = `
                    <h3 style="margin-bottom: 10px; color: var(--primary-start);">📱 如何開啟相機權限</h3>
                    <p style="margin-bottom: 10px; font-size: 14px; line-height: 1.5;">
                        <strong>Chrome/Edge:</strong> 點擊網址列左側的 🔒 或 ⓘ 圖示 → 相機 → 允許<br>
                        <strong>Safari (iOS):</strong> 設定 → Safari → 相機 → 允許<br>
                        <strong>Safari (Mac):</strong> Safari → 偏好設定 → 網站 → 相機
                    </p>
                    <button onclick="this.parentElement.remove()" style="width: 100%; padding: 10px; background: var(--primary-start); color: white; border: none; border-radius: 10px; cursor: pointer;">
                        知道了
                    </button>
                `;
                
                document.body.appendChild(guide);
                
                setTimeout(() => {
                    if (guide.parentElement) {
                        guide.remove();
                    }
                }, 15000);
            }

            async function switchCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                facingMode = facingMode === 'environment' ? 'user' : 'environment';
                await initCamera();
            }

            function capturePhoto() {
                const video = document.getElementById('camera');
                const canvas = document.getElementById('photo-canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                showPhotoPreview(imageData);
            }

            function showPhotoPreview(imageData) {
                const preview = document.getElementById('photo-preview');
                preview.src = imageData;
                preview.dataset.imageData = imageData;
                preview.style.display = 'block';
                document.getElementById('edit-container').classList.remove('hidden');
                selections = [];
                showNotification('圖片載入成功');
            }

            function startSelection(type) {
                currentSelectionType = type;
                selectionMode = true;
                
                const img = document.getElementById('photo-preview');
                img.style.cursor = 'crosshair';
                img.addEventListener('mousedown', handleSelectionStart);
                
                showNotification(`請框選${type === 'question' ? '題目' : '答案'}區域`);
            }

            function handleSelectionStart(e) {
                const rect = e.target.getBoundingClientRect();
                selectionStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };

                const overlay = document.createElement('div');
                overlay.className = `selection-overlay ${currentSelectionType}`;
                overlay.style.left = selectionStart.x + 'px';
                overlay.style.top = selectionStart.y + 'px';
                e.target.parentElement.appendChild(overlay);
                
                document.addEventListener('mousemove', updateSelection);
                document.addEventListener('mouseup', endSelection);
                
                function updateSelection(e) {
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    overlay.style.width = Math.abs(currentX - selectionStart.x) + 'px';
                    overlay.style.height = Math.abs(currentY - selectionStart.y) + 'px';
                    overlay.style.left = Math.min(selectionStart.x, currentX) + 'px';
                    overlay.style.top = Math.min(selectionStart.y, currentY) + 'px';
                }
                
                function endSelection() {
                    document.removeEventListener('mousemove', updateSelection);
                    document.removeEventListener('mouseup', endSelection);
                    
                    selections.push({
                        type: currentSelectionType,
                        bounds: {
                            left: parseInt(overlay.style.left),
                            top: parseInt(overlay.style.top),
                            width: parseInt(overlay.style.width),
                            height: parseInt(overlay.style.height)
                        }
                    });
                    
                    selectionMode = false;
                    e.target.style.cursor = 'default';
                    e.target.removeEventListener('mousedown', handleSelectionStart);
                }
            }

            function clearSelections() {
                const container = document.getElementById('photo-preview').parentElement;
                container.querySelectorAll('.selection-overlay').forEach(el => el.remove());
                selections = [];
                showNotification('已清除框選');
            }

            function saveQuestion() {
                const subjectSelect = document.getElementById('subject');
                const customSubjectInput = document.getElementById('custom-subject');
                let subject = subjectSelect.value;
                
                // 處理自訂科目
                if (subject === 'custom') {
                    const customSubject = customSubjectInput.value.trim();
                    if (!customSubject) {
                        showNotification('請輸入科目名稱', 'error');
                        customSubjectInput.focus();
                        return;
                    }
                    subject = 'custom:' + customSubject;
                }
                
                const questionType = document.getElementById('question-type').value;
                const errorReason = document.getElementById('error-reason').value;
                const notes = document.getElementById('notes').value;
                const imageData = document.getElementById('photo-preview').dataset.imageData;

                if (!subject || !questionType || !errorReason) {
                    showNotification('請填寫所有欄位', 'error');
                    return;
                }

                questions.push({
                    id: Date.now().toString(),
                    subject,
                    questionType,
                    errorReason,
                    notes,
                    imageData,
                    selections,
                    createdAt: new Date().toISOString()
                });

                saveQuestions();
                showNotification('錯題已儲存');
                resetEdit();
            }

            function resetEdit() {
                document.getElementById('edit-container').classList.add('hidden');
                document.getElementById('subject').value = '';
                document.getElementById('question-type').value = '';
                document.getElementById('error-reason').value = '';
                document.getElementById('notes').value = '';
                clearSelections();
            }

            function displayQuestions() {
                const container = document.getElementById('questions-list');
                
                if (questions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">尚未添加任何錯題</p>';
                    return;
                }

                container.innerHTML = questions.map(q => `
                    <div class="question-item" onclick="MistakeApp.showModal('${q.id}')">
                        <img src="${q.imageData}" alt="錯題">
                        <p><strong>${getSubjectName(q.subject)}</strong> - ${getTypeName(q.questionType)}</p>
                        <p style="color: var(--text-muted); font-size: 14px;">${escapeHtml(q.notes) || '無筆記'}</p>
                    </div>
                `).join('');
            }

            function filterQuestions() {
                const filter = document.getElementById('filter-subject').value;
                const filtered = filter === 'all' ? questions : questions.filter(q => q.subject === filter);
                
                const container = document.getElementById('questions-list');
                if (filtered.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">沒有符合條件的錯題</p>';
                    return;
                }

                container.innerHTML = filtered.map(q => `
                    <div class="question-item" onclick="MistakeApp.showModal('${q.id}')">
                        <img src="${q.imageData}" alt="錯題">
                        <p><strong>${getSubjectName(q.subject)}</strong> - ${getTypeName(q.questionType)}</p>
                        <p style="color: var(--text-muted); font-size: 14px;">${escapeHtml(q.notes) || '無筆記'}</p>
                    </div>
                `).join('');
            }

            function showModal(id) {
                const question = questions.find(q => q.id === id);
                if (!question) return;

                currentQuestionId = id;
                document.getElementById('modal-image').src = question.imageData;
                document.getElementById('modal-subject').textContent = getSubjectName(question.subject);
                document.getElementById('modal-type').textContent = getTypeName(question.questionType);
                document.getElementById('modal-reason').textContent = getReasonName(question.errorReason);
                document.getElementById('modal-notes').textContent = question.notes || '無筆記';
                document.getElementById('question-modal').style.display = 'block';
            }

            function closeModal() {
                document.getElementById('question-modal').style.display = 'none';
                currentQuestionId = null;
            }

            function deleteQuestion() {
                if (!confirm('確定要刪除？')) return;
                
                questions = questions.filter(q => q.id !== currentQuestionId);
                saveQuestions();
                closeModal();
                displayQuestions();
                showNotification('已刪除');
            }

            function exportData() {
                if (questions.length === 0) {
                    showNotification('沒有資料', 'error');
                    return;
                }

                const data = JSON.stringify({ questions, exportDate: new Date().toISOString() }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `錯題集_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('已匯出');
            }

            function clearAllData() {
                if (!confirm('確定要清除所有資料？')) return;
                
                questions = [];
                localStorage.removeItem('questions');
                updateDisplay();
                showNotification('已清除');
            }

            function updateDisplay() {
                document.getElementById('total-questions').textContent = questions.length;
                displayQuestions();
            }

            function getSubjectName(subject) {
                // 處理自訂科目
                if (subject.startsWith('custom:')) {
                    return subject.substring(7); // 移除 'custom:' 前綴
                }
                
                const names = { 
                    chinese: '國文', 
                    english: '英文', 
                    math: '數學', 
                    science: '自然', 
                    social: '社會'
                };
                return names[subject] || subject;
            }

            function getTypeName(type) {
                const names = { 
                    'true-false': '是非題', 
                    'multiple-choice': '選擇題', 
                    'short-answer': '簡答題', 
                    'essay': '申論題', 
                    'calculation': '計算題', 
                    'other': '其他' 
                };
                return names[type] || type;
            }

            function getReasonName(reason) {
                const names = { 
                    'dont-know': '此題不會', 
                    'calculation-error': '計算錯誤', 
                    'concept-error': '觀念錯誤', 
                    'careless': '粗心', 
                    'other': '其他' 
                };
                return names[reason] || reason;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // 標籤頁切換
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(this.dataset.tab + '-tab').classList.remove('hidden');
                    
                    if (this.dataset.tab === 'collection') {
                        displayQuestions();
                    }
                });
            });

            // 公開 API
            return {
                capturePhoto,
                switchCamera,
                startSelection,
                clearSelections,
                saveQuestion,
                resetEdit,
                showModal,
                closeModal,
                deleteQuestion,
                exportData,
                clearAllData,
                filterQuestions
            };
        })();
    </script>
</body>
</html>
