<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <title>eCoach - æ™ºæ…§éŒ¯é¡Œç®¡ç†ç³»çµ±</title>
    <style>
        :root {
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --success: #28a745;
            --error: #dc3545;
            --text-muted: #6c757d;
            --bg-light: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            min-height: 100vh;
            padding: 20px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 15px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        h1 {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, var(--primary-start), var(--primary-end));
            color: white;
            font-size: 1.5em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--bg-light);
            border-bottom: 3px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-start);
            background: white;
            border-bottom: 3px solid var(--primary-start);
        }

        .tab-content {
            padding: 20px;
            min-height: 400px;
        }

        .hidden {
            display: none;
        }

        #camera {
            width: 100%;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 14px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin: 5px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--error), #c82333);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            font-family: inherit;
        }

        .question-item {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            padding: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .question-item:hover {
            transform: translateY(-5px);
        }

        .question-item img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .selection-overlay {
            position: absolute;
            border: 2px dashed var(--primary-start);
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
        }

        .selection-overlay.answer {
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            padding: 20px;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 20px;
            border-radius: 20px;
            max-width: 500px;
            max-height: calc(100vh - 40px);
            overflow: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #photo-preview {
            max-width: 100%;
            border-radius: 15px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="notification" class="notification"></div>

    <div class="container">
        <h1>eCoach - æ™ºæ…§éŒ¯é¡Œç®¡ç†</h1>
        
        <nav class="tabs">
            <button class="tab-btn active" data-tab="capture">ğŸ“¸ æ‹ç…§/åŒ¯å…¥</button>
            <button class="tab-btn" data-tab="collection">ğŸ“š éŒ¯é¡Œé›†</button>
        </nav>
        
        <main>
            <section class="tab-content" id="capture-tab">
                <div style="text-align: center;">
                    <video id="camera" autoplay playsinline muted></video>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                    
                    <div>
                        <button class="btn-primary" onclick="MistakeApp.capturePhoto()">ğŸ“¸ æ‹ç…§</button>
                        <button class="btn-secondary" onclick="document.getElementById('file-input').click()">ğŸ“ åŒ¯å…¥åœ–ç‰‡</button>
                        <button class="btn-secondary" onclick="MistakeApp.switchCamera()">ğŸ”„ åˆ‡æ›ç›¸æ©Ÿ</button>
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                    </div>
                </div>
                
                <div id="edit-container" class="hidden" style="margin-top: 20px;">
                    <div style="position: relative; display: inline-block;">
                        <img id="photo-preview" alt="é è¦½åœ–ç‰‡" style="display: none;">
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn-secondary" onclick="MistakeApp.startSelection('question')">ğŸ“ æ¡†é¸é¡Œç›®</button>
                        <button class="btn-success" onclick="MistakeApp.startSelection('answer')">âœ… æ¡†é¸ç­”æ¡ˆ</button>
                        <button class="btn-danger" onclick="MistakeApp.clearSelections()">ğŸ—‘ï¸ æ¸…é™¤æ¡†é¸</button>
                    </div>
                    
                    <div class="form-group">
                        <label>ç§‘ç›®:</label>
                        <select id="subject" onchange="handleSubjectChange()">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="chinese">åœ‹æ–‡</option>
                            <option value="english">è‹±æ–‡</option>
                            <option value="math">æ•¸å­¸</option>
                            <option value="science">è‡ªç„¶</option>
                            <option value="social">ç¤¾æœƒ</option>
                            <option value="custom">è‡ªè¨‚ç§‘ç›®...</option>
                        </select>
                        <input type="text" id="custom-subject" placeholder="è«‹è¼¸å…¥ç§‘ç›®åç¨±" style="display: none; width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>é¡Œå‹:</label>
                        <select id="question-type">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="true-false">æ˜¯éé¡Œ</option>
                            <option value="multiple-choice">é¸æ“‡é¡Œ</option>
                            <option value="short-answer">ç°¡ç­”é¡Œ</option>
                            <option value="essay">ç”³è«–é¡Œ</option>
                            <option value="calculation">è¨ˆç®—é¡Œ</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>éŒ¯èª¤åŸå› :</label>
                        <select id="error-reason">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="dont-know">æ­¤é¡Œä¸æœƒ</option>
                            <option value="calculation-error">è¨ˆç®—éŒ¯èª¤</option>
                            <option value="concept-error">è§€å¿µéŒ¯èª¤</option>
                            <option value="careless">ç²—å¿ƒ</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ç­†è¨˜:</label>
                        <textarea id="notes" placeholder="æ·»åŠ ç­†è¨˜..."></textarea>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn-success" onclick="MistakeApp.saveQuestion()">ğŸ’¾ å„²å­˜</button>
                        <button class="btn-danger" onclick="MistakeApp.resetEdit()">âŒ å–æ¶ˆ</button>
                    </div>
                </div>
            </section>
            
            <section class="tab-content hidden" id="collection-tab">
                <h2 style="text-align: center;">ğŸ“š éŒ¯é¡Œé›†</h2>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn-secondary" onclick="MistakeApp.exportData()">ğŸ“¤ åŒ¯å‡º</button>
                    <button class="btn-secondary" onclick="document.getElementById('import-data-input').click()">ğŸ“¥ åŒ¯å…¥</button>
                    <button class="btn-danger" onclick="MistakeApp.clearAllData()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <input type="file" id="import-data-input" accept=".json" class="hidden">
                </div>
                
                <p style="text-align: center; color: var(--text-muted);">
                    ç¸½è¨ˆ: <span id="total-questions">0</span> é¡Œ
                </p>
                
                <div class="form-group">
                    <label>ç¯©é¸ç§‘ç›®:</label>
                    <select id="filter-subject" onchange="MistakeApp.filterQuestions()">
                        <option value="all">å…¨éƒ¨</option>
                        <option value="chinese">åœ‹æ–‡</option>
                        <option value="english">è‹±æ–‡</option>
                        <option value="math">æ•¸å­¸</option>
                        <option value="science">è‡ªç„¶</option>
                        <option value="social">ç¤¾æœƒ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                
                <div id="questions-list">
                    <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                        å°šæœªæ·»åŠ ä»»ä½•éŒ¯é¡Œ
                    </p>
                </div>
            </section>
        </main>
    </div>
    
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="MistakeApp.closeModal()">&times;</span>
            <h2>éŒ¯é¡Œè©³æƒ…</h2>
            <img id="modal-image" style="width: 100%; border-radius: 10px;">
            <p><strong>ç§‘ç›®:</strong> <span id="modal-subject"></span></p>
            <p><strong>é¡Œå‹:</strong> <span id="modal-type"></span></p>
            <p><strong>éŒ¯èª¤åŸå› :</strong> <span id="modal-reason"></span></p>
            <p><strong>ç­†è¨˜:</strong></p>
            <p id="modal-notes" style="background: var(--bg-light); padding: 10px; border-radius: 10px;"></p>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-danger" onclick="MistakeApp.deleteQuestion()">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <script>
        const MistakeApp = (function() {
            let currentStream = null;
            let facingMode = 'environment';
            let questions = [];
            let currentQuestionId = null;
            let selectionMode = false;
            let selectionStart = null;
            let selections = [];
            let currentSelectionType = 'question';

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function() {
                loadQuestions();
                initCamera();
                setupFileInput();
                setupImportData();
                setupSubjectHandler();
            });

            function setupSubjectHandler() {
                window.handleSubjectChange = function() {
                    const select = document.getElementById('subject');
                    const customInput = document.getElementById('custom-subject');
                    
                    if (select.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                        customInput.value = '';
                    }
                };
            }

            function setupFileInput() {
                document.getElementById('file-input').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            showPhotoPreview(event.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function setupImportData() {
                document.getElementById('import-data-input').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.questions && Array.isArray(data.questions)) {
                                if (confirm(`å³å°‡åŒ¯å…¥ ${data.questions.length} ç­†éŒ¯é¡Œï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ`)) {
                                    questions = [...questions, ...data.questions];
                                    saveQuestions();
                                    displayQuestions();
                                    showNotification('è³‡æ–™å·²åŒ¯å…¥');
                                }
                            }
                        } catch (error) {
                            showNotification('åŒ¯å…¥å¤±æ•—', 'error');
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = '';
                });
            }

            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            function loadQuestions() {
                const saved = localStorage.getItem('questions');
                questions = saved ? JSON.parse(saved) : [];
                updateDisplay();
            }

            function saveQuestions() {
                localStorage.setItem('questions', JSON.stringify(questions));
                updateDisplay();
            }

            async function initCamera() {
                try {
                    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showNotification('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½ï¼Œè«‹ä½¿ç”¨åŒ¯å…¥åŠŸèƒ½', 'error');
                        disableCameraButtons();
                        return;
                    }

                    // æª¢æŸ¥æ¬Šé™ç‹€æ…‹ï¼ˆå¦‚æœæ”¯æ´ï¼‰
                    if (navigator.permissions && navigator.permissions.query) {
                        try {
                            const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                            
                            if (permissionStatus.state === 'denied') {
                                showNotification('ç›¸æ©Ÿæ¬Šé™å·²è¢«æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­é–‹å•Ÿç›¸æ©Ÿæ¬Šé™', 'error');
                                disableCameraButtons();
                                showCameraPermissionGuide();
                                return;
                            }
                        } catch (e) {
                            console.log('ç„¡æ³•æŸ¥è©¢æ¬Šé™ç‹€æ…‹:', e);
                        }
                    }

                    // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
                    const constraints = { 
                        video: { 
                            facingMode: facingMode,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    };
                    
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    const video = document.getElementById('camera');
                    video.srcObject = currentStream;
                    
                    console.log('ç›¸æ©Ÿåˆå§‹åŒ–æˆåŠŸ');
                    showNotification('ç›¸æ©Ÿå·²é–‹å•Ÿ');
                } catch (error) {
                    console.error('ç›¸æ©ŸéŒ¯èª¤:', error);
                    handleCameraError(error);
                }
            }

            function handleCameraError(error) {
                let errorMessage = 'ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™';
                    showCameraPermissionGuide();
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®ï¼Œè«‹ä½¿ç”¨åŒ¯å…¥åŠŸèƒ½';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'ç›¸æ©Ÿæ­£è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'ç›¸æ©Ÿä¸æ”¯æ´æ‰€éœ€çš„è¨­å®š';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'è«‹ä½¿ç”¨ HTTPS æˆ– localhost é–‹å•Ÿæ­¤é é¢';
                }
                
                showNotification(errorMessage, 'error');
                disableCameraButtons();
            }

            function disableCameraButtons() {
                const captureBtn = document.getElementById('capture-btn');
                const switchBtn = document.getElementById('switch-camera-btn');
                if (captureBtn) captureBtn.disabled = true;
                if (switchBtn) switchBtn.disabled = true;
            }

            function showCameraPermissionGuide() {
                const guide = document.createElement('div');
                guide.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fff;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    max-width: 90%;
                    z-index: 2000;
                `;
                
                guide.innerHTML = `
                    <h3 style="margin-bottom: 10px; color: var(--primary-start);">ğŸ“± å¦‚ä½•é–‹å•Ÿç›¸æ©Ÿæ¬Šé™</h3>
                    <p style="margin-bottom: 10px; font-size: 14px; line-height: 1.5;">
                        <strong>Chrome/Edge:</strong> é»æ“Šç¶²å€åˆ—å·¦å´çš„ ğŸ”’ æˆ– â“˜ åœ–ç¤º â†’ ç›¸æ©Ÿ â†’ å…è¨±<br>
                        <strong>Safari (iOS):</strong> è¨­å®š â†’ Safari â†’ ç›¸æ©Ÿ â†’ å…è¨±<br>
                        <strong>Safari (Mac):</strong> Safari â†’ åå¥½è¨­å®š â†’ ç¶²ç«™ â†’ ç›¸æ©Ÿ
                    </p>
                    <button onclick="this.parentElement.remove()" style="width: 100%; padding: 10px; background: var(--primary-start); color: white; border: none; border-radius: 10px; cursor: pointer;">
                        çŸ¥é“äº†
                    </button>
                `;
                
                document.body.appendChild(guide);
                
                setTimeout(() => {
                    if (guide.parentElement) {
                        guide.remove();
                    }
                }, 15000);
            }

            async function switchCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                facingMode = facingMode === 'environment' ? 'user' : 'environment';
                await initCamera();
            }

            function capturePhoto() {
                const video = document.getElementById('camera');
                const canvas = document.getElementById('photo-canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                showPhotoPreview(imageData);
            }

            function showPhotoPreview(imageData) {
                const preview = document.getElementById('photo-preview');
                preview.src = imageData;
                preview.dataset.imageData = imageData;
                preview.style.display = 'block';
                document.getElementById('edit-container').classList.remove('hidden');
                selections = [];
                showNotification('åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
            }

            function startSelection(type) {
                currentSelectionType = type;
                selectionMode = true;
                
                const img = document.getElementById('photo-preview');
                img.style.cursor = 'crosshair';
                img.addEventListener('mousedown', handleSelectionStart);
                
                showNotification(`è«‹æ¡†é¸${type === 'question' ? 'é¡Œç›®' : 'ç­”æ¡ˆ'}å€åŸŸ`);
            }

            function handleSelectionStart(e) {
                const rect = e.target.getBoundingClientRect();
                selectionStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };

                const overlay = document.createElement('div');
                overlay.className = `selection-overlay ${currentSelectionType}`;
                overlay.style.left = selectionStart.x + 'px';
                overlay.style.top = selectionStart.y + 'px';
                e.target.parentElement.appendChild(overlay);
                
                document.addEventListener('mousemove', updateSelection);
                document.addEventListener('mouseup', endSelection);
                
                function updateSelection(e) {
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    overlay.style.width = Math.abs(currentX - selectionStart.x) + 'px';
                    overlay.style.height = Math.abs(currentY - selectionStart.y) + 'px';
                    overlay.style.left = Math.min(selectionStart.x, currentX) + 'px';
                    overlay.style.top = Math.min(selectionStart.y, currentY) + 'px';
                }
                
                function endSelection() {
                    document.removeEventListener('mousemove', updateSelection);
                    document.removeEventListener('mouseup', endSelection);
                    
                    selections.push({
                        type: currentSelectionType,
                        bounds: {
                            left: parseInt(overlay.style.left),
                            top: parseInt(overlay.style.top),
                            width: parseInt(overlay.style.width),
                            height: parseInt(overlay.style.height)
                        }
                    });
                    
                    selectionMode = false;
                    e.target.style.cursor = 'default';
                    e.target.removeEventListener('mousedown', handleSelectionStart);
                }
            }

            function clearSelections() {
                const container = document.getElementById('photo-preview').parentElement;
                container.querySelectorAll('.selection-overlay').forEach(el => el.remove());
                selections = [];
                showNotification('å·²æ¸…é™¤æ¡†é¸');
            }

            function saveQuestion() {
                const subjectSelect = document.getElementById('subject');
                const customSubjectInput = document.getElementById('custom-subject');
                let subject = subjectSelect.value;
                
                // è™•ç†è‡ªè¨‚ç§‘ç›®
                if (subject === 'custom') {
                    const customSubject = customSubjectInput.value.trim();
                    if (!customSubject) {
                        showNotification('è«‹è¼¸å…¥ç§‘ç›®åç¨±', 'error');
                        customSubjectInput.focus();
                        return;
                    }
                    subject = 'custom:' + customSubject;
                }
                
                const questionType = document.getElementById('question-type').value;
                const errorReason = document.getElementById('error-reason').value;
                const notes = document.getElementById('notes').value;
                const imageData = document.getElementById('photo-preview').dataset.imageData;

                if (!subject || !questionType || !errorReason) {
                    showNotification('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                    return;
                }

                questions.push({
                    id: Date.now().toString(),
                    subject,
                    questionType,
                    errorReason,
                    notes,
                    imageData,
                    selections,
                    createdAt: new Date().toISOString()
                });

                saveQuestions();
                showNotification('éŒ¯é¡Œå·²å„²å­˜');
                resetEdit();
            }

            function resetEdit() {
                document.getElementById('edit-container').classList.add('hidden');
                document.getElementById('subject').value = '';
                document.getElementById('question-type').value = '';
                document.getElementById('error-reason').value = '';
                document.getElementById('notes').value = '';
                clearSelections();
            }

            function displayQuestions() {
                const container = document.getElementById('questions-list');
                
                if (questions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">å°šæœªæ·»åŠ ä»»ä½•éŒ¯é¡Œ</p>';
                    return;
                }

                container.innerHTML = questions.map(q => `
                    <div class="question-item" onclick="MistakeApp.showModal('${q.id}')">
                        <img src="${q.imageData}" alt="éŒ¯é¡Œ">
                        <p><strong>${getSubjectName(q.subject)}</strong> - ${getTypeName(q.questionType)}</p>
                        <p style="color: var(--text-muted); font-size: 14px;">${escapeHtml(q.notes) || 'ç„¡ç­†è¨˜'}</p>
                    </div>
                `).join('');
            }

            function filterQuestions() {
                const filter = document.getElementById('filter-subject').value;
                const filtered = filter === 'all' ? questions : questions.filter(q => q.subject === filter);
                
                const container = document.getElementById('questions-list');
                if (filtered.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-muted);">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„éŒ¯é¡Œ</p>';
                    return;
                }

                container.innerHTML = filtered.map(q => `
                    <div class="question-item" onclick="MistakeApp.showModal('${q.id}')">
                        <img src="${q.imageData}" alt="éŒ¯é¡Œ">
                        <p><strong>${getSubjectName(q.subject)}</strong> - ${getTypeName(q.questionType)}</p>
                        <p style="color: var(--text-muted); font-size: 14px;">${escapeHtml(q.notes) || 'ç„¡ç­†è¨˜'}</p>
                    </div>
                `).join('');
            }

            function showModal(id) {
                const question = questions.find(q => q.id === id);
                if (!question) return;

                currentQuestionId = id;
                document.getElementById('modal-image').src = question.imageData;
                document.getElementById('modal-subject').textContent = getSubjectName(question.subject);
                document.getElementById('modal-type').textContent = getTypeName(question.questionType);
                document.getElementById('modal-reason').textContent = getReasonName(question.errorReason);
                document.getElementById('modal-notes').textContent = question.notes || 'ç„¡ç­†è¨˜';
                document.getElementById('question-modal').style.display = 'block';
            }

            function closeModal() {
                document.getElementById('question-modal').style.display = 'none';
                currentQuestionId = null;
            }

            function deleteQuestion() {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) return;
                
                questions = questions.filter(q => q.id !== currentQuestionId);
                saveQuestions();
                closeModal();
                displayQuestions();
                showNotification('å·²åˆªé™¤');
            }

            function exportData() {
                if (questions.length === 0) {
                    showNotification('æ²’æœ‰è³‡æ–™', 'error');
                    return;
                }

                const data = JSON.stringify({ questions, exportDate: new Date().toISOString() }, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `éŒ¯é¡Œé›†_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('å·²åŒ¯å‡º');
            }

            function clearAllData() {
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
                
                questions = [];
                localStorage.removeItem('questions');
                updateDisplay();
                showNotification('å·²æ¸…é™¤');
            }

            function updateDisplay() {
                document.getElementById('total-questions').textContent = questions.length;
                displayQuestions();
            }

            function getSubjectName(subject) {
                // è™•ç†è‡ªè¨‚ç§‘ç›®
                if (subject.startsWith('custom:')) {
                    return subject.substring(7); // ç§»é™¤ 'custom:' å‰ç¶´
                }
                
                const names = { 
                    chinese: 'åœ‹æ–‡', 
                    english: 'è‹±æ–‡', 
                    math: 'æ•¸å­¸', 
                    science: 'è‡ªç„¶', 
                    social: 'ç¤¾æœƒ'
                };
                return names[subject] || subject;
            }

            function getTypeName(type) {
                const names = { 
                    'true-false': 'æ˜¯éé¡Œ', 
                    'multiple-choice': 'é¸æ“‡é¡Œ', 
                    'short-answer': 'ç°¡ç­”é¡Œ', 
                    'essay': 'ç”³è«–é¡Œ', 
                    'calculation': 'è¨ˆç®—é¡Œ', 
                    'other': 'å…¶ä»–' 
                };
                return names[type] || type;
            }

            function getReasonName(reason) {
                const names = { 
                    'dont-know': 'æ­¤é¡Œä¸æœƒ', 
                    'calculation-error': 'è¨ˆç®—éŒ¯èª¤', 
                    'concept-error': 'è§€å¿µéŒ¯èª¤', 
                    'careless': 'ç²—å¿ƒ', 
                    'other': 'å…¶ä»–' 
                };
                return names[reason] || reason;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // æ¨™ç±¤é åˆ‡æ›
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(this.dataset.tab + '-tab').classList.remove('hidden');
                    
                    if (this.dataset.tab === 'collection') {
                        displayQuestions();
                    }
                });
            });

            // å…¬é–‹ API
            return {
                capturePhoto,
                switchCamera,
                startSelection,
                clearSelections,
                saveQuestion,
                resetEdit,
                showModal,
                closeModal,
                deleteQuestion,
                exportData,
                clearAllData,
                filterQuestions
            };
        })();
    </script>
</body>
</html>
